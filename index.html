<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Калькулятор Капитала</title>
  
  <!-- Подключаем стили Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Подключаем React и ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Подключаем Babel для работы JSX в браузере -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Подключаем Supabase и Telegram -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* Убираем скроллбар для красоты */
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    body { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">

  <div id="root"></div>

  <script type="text/babel">
    // ==========================================
    // НАСТРОЙКИ (Вставь свои данные сюда!)
    // ==========================================
    const SUPABASE_URL = 'https://omxvlwcjtijbjuhjadgj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_aNBhpvGpkfEn1HtaPzEE3w_o7TmgioM';
    // ==========================================

    const { useState, useMemo, useEffect } = React;
    const supabase =  supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tg = window.Telegram.WebApp;

    // Расширяем на весь экран
    tg.expand();

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
    const PERIODS = [
      { key: "monthly", label: "Раз в месяц", perYear: 12 },
      { key: "quarterly", label: "Раз в квартал", perYear: 4 },
      { key: "yearly", label: "Раз в год", perYear: 1 },
      { key: "weekly", label: "Раз в неделю", perYear: 52 },
      { key: "daily", label: "Ежедневно", perYear: 365 },
    ];

    const cf = new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB", maximumFractionDigits: 0 });
    const pf = new Intl.NumberFormat("ru-RU", { style: "percent", maximumFractionDigits: 1 });

    function gcd(a, b) { return b === 0 ? Math.abs(a) : gcd(b, a % b); }
    function lcm(a, b) { return Math.abs(a * b) / gcd(a, b); }

    function simulateFV({ principal, apr, years, contribution, contribPerYear, compoundPerYear, reinvest }) {
      const stepsPerYear = lcm(Math.max(1, compoundPerYear), Math.max(1, contribPerYear));
      const totalSteps = Math.round(stepsPerYear * years);
      const stepIsCompoundEvery = stepsPerYear / Math.max(1, compoundPerYear);
      const stepIsContribEvery = stepsPerYear / Math.max(1, contribPerYear);
      const stepRate = Math.pow(1 + apr, 1 / Math.max(1, compoundPerYear)) - 1;

      let balance = Math.max(0, principal);
      let paidIn = Math.max(0, principal);
      let incomeWithdrawn = 0;

      for (let s = 1; s <= totalSteps; s++) {
        if (contribPerYear > 0 && s % stepIsContribEvery === 0) {
          balance += contribution;
          paidIn += contribution;
        }
        if (compoundPerYear > 0 && s % stepIsCompoundEvery === 0) {
          const interest = balance * stepRate;
          if (reinvest) balance += interest; else incomeWithdrawn += interest;
        }
      }
      const fv = balance;
      const income = reinvest ? fv - paidIn : incomeWithdrawn;
      return { fv, paidIn, income };
    }

    // --- КОМПОНЕНТЫ UI ---
    function Toggle({ checked, onChange, label }) {
      return (
        <label className="flex items-center gap-3 cursor-pointer select-none">
          <button type="button" onClick={() => onChange(!checked)} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${checked ? "bg-indigo-600" : "bg-zinc-300"}`}>
            <span className={`inline-block h-4 w-4 transform rounded-full bg-white shadow transition ${checked ? "translate-x-6" : "translate-x-1"}`} />
          </button>
          <span className="text-sm font-medium">{label}</span>
        </label>
      );
    }

    function SliderRow({ label, value, setValue, min, max, step = 1, formatRight, disabled = false }) {
      return (
        <div className="flex flex-col gap-2 mb-4">
          <div className="flex justify-between">
             <span className="text-sm text-zinc-600 font-medium">{label}</span>
             <span className="text-xs text-indigo-600 font-bold">{formatRight(value)}</span>
          </div>
          <input type="range" min={min} max={max} step={step} value={Number.isFinite(value) ? value : 0} onChange={(e) => setValue(Number(e.target.value))} disabled={disabled} className="w-full h-2 bg-zinc-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" />
        </div>
      );
    }

    // --- ОСНОВНОЕ ПРИЛОЖЕНИЕ ---
    function App() {
      // Инициализация ID пользователя
      const userId = tg.initDataUnsafe?.user?.id || 12345; // 12345 для тестов в браузере
      const [loading, setLoading] = useState(true);
      const [status, setStatus] = useState("");

      // Состояния калькулятора
      const [target, setTarget] = useState(10000000);
      const [principal, setPrincipal] = useState(100000);
      const [years, setYears] = useState(10);
      const [contrib, setContrib] = useState(10000);
      const [aprPercent, setAprPercent] = useState(15); // Средняя ставка
      const [reinvest, setReinvest] = useState(true);

      // Загрузка данных при старте
      useEffect(() => {
        async function loadData() {
          const { data, error } = await supabase
            .from('user_saves')
            .select('data')
            .eq('user_id', userId)
            .single();
          
          if (data && data.data) {
            const s = data.data;
            if (s.target) setTarget(s.target);
            if (s.principal) setPrincipal(s.principal);
            if (s.years) setYears(s.years);
            if (s.contrib) setContrib(s.contrib);
            if (s.aprPercent) setAprPercent(s.aprPercent);
          }
          setLoading(false);
        }
        loadData();
      }, []);

      // Авто-сохранение (Debounce 1 сек)
      useEffect(() => {
        if (loading) return;
        const timer = setTimeout(async () => {
          setStatus("Сохранение...");
          const saveData = { target, principal, years, contrib, aprPercent };
          await supabase.from('user_saves').upsert({ user_id: userId, data: saveData });
          setStatus("Сохранено ✅");
          setTimeout(() => setStatus(""), 2000);
        }, 1000);
        return () => clearTimeout(timer);
      }, [target, principal, years, contrib, aprPercent]);

      // Расчеты
      const result = useMemo(() => {
        return simulateFV({
          principal, 
          apr: aprPercent / 100, 
          years, 
          contribution: contrib, 
          contribPerYear: 12, 
          compoundPerYear: 12, 
          reinvest 
        });
      }, [principal, aprPercent, years, contrib, reinvest]);

      const progress = target > 0 ? Math.min(1, result.fv / target) : 0;

      if (loading) return <div className="flex h-screen items-center justify-center">Загрузка данных...</div>;

      return (
        <div className="max-w-md mx-auto bg-white min-h-screen flex flex-col">
          
          {/* Шапка */}
          <div className="bg-indigo-600 p-6 rounded-b-3xl shadow-lg text-white mb-6">
            <div className="flex justify-between items-start">
                <div>
                    <div className="text-indigo-200 text-sm font-medium uppercase tracking-wider">Ваш Капитал через {years} лет</div>
                    <div className="text-4xl font-bold mt-1">{cf.format(result.fv)}</div>
                </div>
                <div className="text-xs text-indigo-200">{status}</div>
            </div>
            
            <div className="mt-6">
                <div className="flex justify-between text-xs text-indigo-100 mb-1">
                    <span>Прогресс к цели {cf.format(target)}</span>
                    <span>{Math.round(progress * 100)}%</span>
                </div>
                <div className="h-2 bg-indigo-900/30 rounded-full overflow-hidden">
                    <div className="h-full bg-white transition-all duration-500" style={{width: `${progress * 100}%`}}></div>
                </div>
            </div>
            
            <div className="flex justify-between mt-4 text-sm text-indigo-100">
               <div>Вложено: <span className="font-bold text-white">{cf.format(result.paidIn)}</span></div>
               <div>Доход: <span className="font-bold text-white">{cf.format(result.income)}</span></div>
            </div>
          </div>

          {/* Управление */}
          <div className="px-6 flex-1 pb-10">
            
            <div className="bg-white border border-zinc-100 shadow-sm rounded-2xl p-5 mb-4">
                <h3 className="text-lg font-bold text-zinc-800 mb-4">Параметры Двигателя</h3>
                
                <SliderRow 
                    label="Моя Цель" 
                    value={target} 
                    setValue={setTarget} 
                    min={1000000} max={100000000} step={500000} 
                    formatRight={cf.format} 
                />
                
                <SliderRow 
                    label="Стартовый капитал" 
                    value={principal} 
                    setValue={setPrincipal} 
                    min={0} max={10000000} step={50000} 
                    formatRight={cf.format} 
                />
                
                <SliderRow 
                    label="Срок (лет)" 
                    value={years} 
                    setValue={setYears} 
                    min={1} max={40} step={1} 
                    formatRight={(n) => n + " лет"} 
                />

                <SliderRow 
                    label="Ежемесячное пополнение" 
                    value={contrib} 
                    setValue={setContrib} 
                    min={0} max={500000} step={1000} 
                    formatRight={cf.format} 
                />

                <SliderRow 
                    label="Доходность портфеля" 
                    value={aprPercent} 
                    setValue={setAprPercent} 
                    min={1} max={50} step={0.5} 
                    formatRight={(n) => n + "%"} 
                />
            </div>

            <div className="text-center">
                <button onClick={() => tg.close()} className="text-zinc-400 text-sm py-4">Закрыть калькулятор</button>
            </div>

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
