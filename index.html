<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –î–ù–ö –ò–Ω–≤–µ—Å—Ç–æ—Ä–∞</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            zinc: { 850: '#202022', 900: '#18181b', 950: '#09090b' }
          }
        }
      }
    }
  </script>
  
  <!-- React & DOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Supabase & Telegram -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    body { -webkit-tap-highlight-color: transparent; background-color: #09090b; color: #fafafa; }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    // ==========================================
    // üõë –í–°–¢–ê–í–¨ –°–Æ–î–ê –î–ê–ù–ù–´–ï –ò–ó SUPABASE
    // ==========================================
    const SUPABASE_URL = 'https://omxvlwcjtijbjuhjadgj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_aNBhpvGpkfEn1HtaPzEE3w_o7TmgioM';
    // ==========================================

    const { useState, useMemo, useEffect } = React;
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tg = window.Telegram.WebApp;

    tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    tg.enableClosingConfirmation(); // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò –ö–û–ù–°–¢–ê–ù–¢–´ ---
    const PERIODS = [
      { key: "monthly", label: "–†–∞–∑ –≤ –º–µ—Å—è—Ü", perYear: 12 },
      { key: "quarterly", label: "–†–∞–∑ –≤ –∫–≤–∞—Ä—Ç–∞–ª", perYear: 4 },
      { key: "yearly", label: "–†–∞–∑ –≤ –≥–æ–¥", perYear: 1 },
    ];

    const cf = new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB", maximumFractionDigits: 0 });
    const pf = new Intl.NumberFormat("ru-RU", { style: "percent", maximumFractionDigits: 1 });

    function gcd(a, b) { return b === 0 ? Math.abs(a) : gcd(b, a % b); }
    function lcm(a, b) { return Math.abs(a * b) / gcd(a, b); }

    function simulateFV({ principal, apr, years, contribution, contribPerYear, compoundPerYear, reinvest }) {
      const stepsPerYear = lcm(Math.max(1, compoundPerYear), Math.max(1, contribPerYear));
      const totalSteps = Math.round(stepsPerYear * years);
      const stepRate = Math.pow(1 + apr, 1 / Math.max(1, compoundPerYear)) - 1;
      const stepIsContribEvery = stepsPerYear / Math.max(1, contribPerYear);
      const stepIsCompoundEvery = stepsPerYear / Math.max(1, compoundPerYear);

      let balance = Math.max(0, principal);
      let paidIn = Math.max(0, principal);
      let incomeWithdrawn = 0;

      for (let s = 1; s <= totalSteps; s++) {
        if (contribPerYear > 0 && s % stepIsContribEvery === 0) {
          balance += contribution;
          paidIn += contribution;
        }
        if (compoundPerYear > 0 && s % stepIsCompoundEvery === 0) {
          const interest = balance * stepRate;
          if (reinvest) balance += interest; else incomeWithdrawn += interest;
        }
      }
      return { fv: balance, paidIn, income: reinvest ? balance - paidIn : incomeWithdrawn };
    }

    // --- –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI (–ö–ê–ö –í –¢–í–û–ï–ú –û–†–ò–ì–ò–ù–ê–õ–ï) ---
    function Toggle({ checked, onChange, label }) {
      return (
        <label className="flex items-center gap-3 cursor-pointer select-none py-2">
          <div className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${checked ? "bg-indigo-600" : "bg-zinc-700"}`}>
            <span className={`inline-block h-4 w-4 transform rounded-full bg-white shadow transition ${checked ? "translate-x-6" : "translate-x-1"}`} />
          </div>
          <input type="checkbox" className="hidden" checked={checked} onChange={(e) => onChange(e.target.checked)} />
          <span className="text-sm text-zinc-300">{label}</span>
        </label>
      );
    }

    function Segmented({ options, value, onChange }) {
      return (
        <div className="inline-flex w-full rounded-xl border border-zinc-700 p-1 bg-zinc-900">
          {options.map(opt => (
            <button key={opt.key} type="button" onClick={() => onChange(opt.key)} 
              className={`flex-1 px-2 py-1.5 rounded-lg text-xs md:text-sm font-medium transition ${value === opt.key ? "bg-indigo-600 text-white" : "text-zinc-400 hover:bg-zinc-800"}`}>
              {opt.label}
            </button>
          ))}
        </div>
      );
    }

    function SliderRow({ label, value, setValue, min, max, step = 1, formatRight, disabled = false }) {
      return (
        <div className="flex flex-col gap-2 mb-5">
          <div className="flex justify-between items-end">
             <span className="text-sm text-zinc-400">{label}</span>
             <div className="text-sm font-mono bg-zinc-800 px-2 py-1 rounded border border-zinc-700 text-zinc-100 min-w-[80px] text-right">
                {formatRight(value)}
             </div>
          </div>
          <input type="range" min={min} max={max} step={step} value={Number.isFinite(value) ? value : 0} 
            onChange={(e) => setValue(Number(e.target.value))} disabled={disabled} 
            className="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
        </div>
      );
    }

    function EditableTable({ title, rows, setRows }) {
      const sumW = rows.reduce((a, b) => a + (Number.isFinite(b.w) ? b.w : 0), 0);
      
      function update(idx, key, val) {
        const copy = [...rows];
        if (key === "w" || key === "r" || key === "s") {
          const num = Number(val);
          copy[idx] = { ...copy[idx], [key]: isFinite(num) ? num : 0 };
        } else {
          copy[idx] = { ...copy[idx], [key]: String(val) };
        }
        setRows(copy);
      }
      function add() { setRows([...rows, { ticker: "NEW", w: 0.1, r: 0.15, s: 0.2 }]); }
      function remove(i) { const copy = [...rows]; copy.splice(i, 1); setRows(copy); }
      function normalize() {
        const total = rows.reduce((a, b) => a + b.w, 0) || 1;
        setRows(rows.map(r => ({ ...r, w: Number((r.w / total).toFixed(2)) })));
      }

      return (
        <div className="rounded-2xl border border-zinc-700 bg-zinc-900 p-4 mb-4">
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm font-bold text-zinc-100">{title}</div>
            <div className={`text-xs ${Math.abs(sumW - 1) > 0.01 ? 'text-red-400' : 'text-green-400'}`}>
              –î–æ–ª–∏: {(sumW * 100).toFixed(0)}%
            </div>
          </div>
          <div className="space-y-2">
            {rows.map((row, idx) => (
              <div key={idx} className="grid grid-cols-12 gap-2 items-center">
                <input value={row.ticker} onChange={e => update(idx, "ticker", e.target.value)} 
                  className="col-span-4 bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-xs text-white" placeholder="–¢–∏–∫–µ—Ä" />
                <div className="col-span-3 flex items-center gap-1">
                   <input type="number" value={Number((row.w).toFixed(2))} step={0.05} onChange={e => update(idx, "w", e.target.value)} 
                     className="w-full bg-zinc-800 border border-zinc-700 rounded px-1 py-1 text-xs text-white text-right" />
                </div>
                <div className="col-span-3 flex items-center gap-1">
                   <input type="number" value={Math.round(row.r * 100)} step={1} onChange={e => update(idx, "r", Number(e.target.value)/100)} 
                     className="w-full bg-zinc-800 border border-zinc-700 rounded px-1 py-1 text-xs text-white text-right" />
                   <span className="text-[10px] text-zinc-500">%</span>
                </div>
                <button onClick={() => remove(idx)} className="col-span-2 text-zinc-500 hover:text-red-400 text-xs">‚úï</button>
              </div>
            ))}
          </div>
          <div className="flex gap-2 mt-3">
            <button onClick={add} className="flex-1 py-1.5 bg-indigo-600/20 text-indigo-300 rounded-lg text-xs hover:bg-indigo-600/30">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onClick={normalize} className="flex-1 py-1.5 border border-zinc-700 text-zinc-400 rounded-lg text-xs hover:bg-zinc-800">–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      );
    }

    // --- –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
    function App() {
      const userId = tg.initDataUnsafe?.user?.id || 12345; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
      const [tab, setTab] = useState("calc");
      const [target, setTarget] = useState(10000000);
      const [principal, setPrincipal] = useState(100000);
      const [years, setYears] = useState(10);
      const [contrib, setContrib] = useState(10000);
      const [reinvest, setReinvest] = useState(true);

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è
      const [bondShare, setBondShare] = useState(0.7);
      const [bonds, setBonds] = useState([
        { ticker: "–û–§–ó-26238", w: 0.35, r: 0.11, s: 0.04 },
        { ticker: "–û–§–ó-26212", w: 0.35, r: 0.10, s: 0.04 },
        { ticker: "GAZP-OBL",  w: 0.15, r: 0.12, s: 0.06 },
        { ticker: "SBER-OBL",  w: 0.15, r: 0.12, s: 0.06 },
      ]);
      const [stocks, setStocks] = useState([
        { ticker: "SBER", w: 0.20, r: 0.22, s: 0.30 },
        { ticker: "GAZP", w: 0.20, r: 0.20, s: 0.35 },
        { ticker: "YNDX", w: 0.20, r: 0.24, s: 0.35 },
        { ticker: "LKOH", w: 0.20, r: 0.20, s: 0.28 },
        { ticker: "MGNT", w: 0.20, r: 0.18, s: 0.25 },
      ]);

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Supabase
      useEffect(() => {
        async function load() {
          const { data } = await supabase.from('user_saves').select('data').eq('user_id', userId).single();
          if (data?.data) {
            const s = data.data;
            if (s.target) setTarget(s.target);
            if (s.principal) setPrincipal(s.principal);
            if (s.years) setYears(s.years);
            if (s.contrib) setContrib(s.contrib);
            if (s.bondShare !== undefined) setBondShare(s.bondShare);
            if (s.bonds) setBonds(s.bonds);
            if (s.stocks) setStocks(s.stocks);
            if (s.reinvest !== undefined) setReinvest(s.reinvest);
          }
          setLoading(false);
        }
        load();
      }, []);

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö)
      useEffect(() => {
        if (loading) return;
        const timer = setTimeout(async () => {
          setSaving(true);
          const saveData = { target, principal, years, contrib, bondShare, bonds, stocks, reinvest };
          await supabase.from('user_saves').upsert({ user_id: userId, data: saveData });
          setSaving(false);
        }, 2000);
        return () => clearTimeout(timer);
      }, [target, principal, years, contrib, bondShare, bonds, stocks, reinvest]);

      // --- –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–û–í (–ò–ó –¢–í–û–ï–ì–û –ö–û–î–ê) ---
      const getStats = (rows) => {
        const ret = rows.reduce((a, r) => a + r.w * r.r, 0);
        const sigma = Math.sqrt(rows.reduce((a, r) => a + Math.pow(r.w * r.s, 2), 0));
        return { ret, sigma };
      };

      const bondsStat = useMemo(() => getStats(bonds), [bonds]);
      const stocksStat = useMemo(() => getStats(stocks), [stocks]);
      
      // –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è (rho) —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ 0.2 –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è, –∏–ª–∏ –¥–æ–±–∞–≤—å —Å–ª–∞–π–¥–µ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      const rho = 0.2; 
      const portRet = bondShare * bondsStat.ret + (1 - bondShare) * stocksStat.ret;
      const portSigma = Math.sqrt(
        Math.pow(bondShare * bondsStat.sigma, 2) + 
        Math.pow((1 - bondShare) * stocksStat.sigma, 2) + 
        2 * bondShare * (1 - bondShare) * rho * bondsStat.sigma * stocksStat.sigma
      );

      const result = useMemo(() => {
        return simulateFV({
          principal,
          apr: portRet,
          years,
          contribution: contrib,
          contribPerYear: 12,
          compoundPerYear: 12,
          reinvest
        });
      }, [principal, portRet, years, contrib, reinvest]);

      const progress = target > 0 ? Math.min(1, result.fv / target) : 0;

      // –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –≥–æ–¥–∞–º
      const forecast = useMemo(() => {
        const rows = [];
        for (let y = 0; y <= years; y++) {
          const r = simulateFV({ principal, apr: portRet, years: y, contribution: contrib, contribPerYear: 12, compoundPerYear: 12, reinvest });
          rows.push({ year: y, ...r });
        }
        return rows;
      }, [principal, portRet, years, contrib, reinvest]);

      if (loading) return <div className="flex h-screen items-center justify-center text-zinc-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>;

      return (
        <div className="min-h-screen pb-20">
          
          {/* –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ (–†–µ–∑—É–ª—å—Ç–∞—Ç) */}
          <div className="bg-indigo-600 p-6 pb-8 rounded-b-[30px] shadow-xl mb-6 relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-30 pointer-events-none">
               {/* –î–µ–∫–æ—Ä */}
               <svg width="100" height="100" viewBox="0 0 24 24" fill="white"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>
            </div>
            
            <div className="relative z-10">
              <div className="flex justify-between items-start">
                <div className="text-indigo-200 text-xs uppercase tracking-widest font-semibold mb-1">–í–∞—à –∫–∞–ø–∏—Ç–∞–ª —á–µ—Ä–µ–∑ {Math.round(years)} –ª–µ—Ç</div>
                <div className="text-[10px] text-indigo-300">{saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–ì–æ—Ç–æ–≤–æ"}</div>
              </div>
              <div className="text-4xl font-bold text-white mb-6">{cf.format(result.fv)}</div>
              
              <div className="mb-2 flex justify-between text-xs text-indigo-100">
                <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏ {cf.format(target)}</span>
                <span>{(progress * 100).toFixed(0)}%</span>
              </div>
              <div className="h-2 bg-indigo-900/40 rounded-full overflow-hidden mb-4">
                <div className="h-full bg-white transition-all duration-700 ease-out" style={{width: `${progress*100}%`}}></div>
              </div>
              
              <div className="grid grid-cols-2 gap-4 text-xs text-indigo-100/80 border-t border-indigo-500/30 pt-4">
                 <div>
                    <div className="mb-1">–í–ª–æ–∂–µ–Ω–æ —Å–≤–æ–∏—Ö</div>
                    <div className="text-white font-semibold text-sm">{cf.format(result.paidIn)}</div>
                 </div>
                 <div className="text-right">
                    <div className="mb-1">–î–æ—Ö–æ–¥ –æ—Ç %</div>
                    <div className="text-white font-semibold text-sm">{cf.format(result.income)}</div>
                 </div>
              </div>
            </div>
          </div>

          {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ */}
          <div className="px-4 mb-6">
             <Segmented options={[{key:"calc",label:"–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"}, {key:"forecast",label:"–ü—Ä–æ–≥–Ω–æ–∑"}]} value={tab} onChange={setTab} />
          </div>

          {tab === "calc" && (
            <div className="px-4 space-y-6 animate-fade-in">
              
              {/* –ë–ª–æ–∫ 1: –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5 shadow-sm">
                <h3 className="text-base font-bold text-white mb-4">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –î–≤–∏–≥–∞—Ç–µ–ª—è</h3>
                <SliderRow label="–ú–æ—è –¶–µ–ª—å" value={target} setValue={setTarget} min={100000} max={50000000} step={100000} formatRight={cf.format} />
                <SliderRow label="–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª" value={principal} setValue={setPrincipal} min={0} max={10000000} step={50000} formatRight={cf.format} />
                <SliderRow label="–°—Ä–æ–∫ (–ª–µ—Ç)" value={years} setValue={setYears} min={1} max={40} step={1} formatRight={n=>n+" –ª–µ—Ç"} />
                <SliderRow label="–ï–∂–µ–º–µ—Å—è—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" value={contrib} setValue={setContrib} min={0} max={500000} step={1000} formatRight={cf.format} />
                <div className="mt-4 pt-4 border-t border-zinc-800">
                   <Toggle checked={reinvest} onChange={setReinvest} label="–†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ö–æ–¥" />
                </div>
              </div>

              {/* –ë–ª–æ–∫ 2: –ü–æ—Ä—Ç—Ñ–µ–ª—å */}
              <div className="bg-zinc-900 border border-zinc-800 rounded-2xl p-5 shadow-sm">
                <h3 className="text-base font-bold text-white mb-2">–ê–ª–ª–æ–∫–∞—Ü–∏—è –ê–∫—Ç–∏–≤–æ–≤</h3>
                <div className="text-xs text-zinc-500 mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞—à–µ–≥–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è —Ä–∏—Å–∫–∞ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏</div>
                
                <SliderRow 
                  label="–î–æ–ª—è –û–±–ª–∏–≥–∞—Ü–∏–π (–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å)" 
                  value={bondShare * 100} 
                  setValue={(v) => setBondShare(v/100)} 
                  min={0} max={100} 
                  formatRight={(n) => `${n}%`} 
                />
                <div className="flex justify-between text-xs text-zinc-500 mb-6 px-1">
                   <span>–ê–∫—Ü–∏–∏: {(100 - bondShare*100).toFixed(0)}%</span>
                   <span>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è: <span className="text-indigo-400 font-bold">{pf.format(portRet)}</span></span>
                </div>

                <EditableTable title="–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫ (–û–±–ª–∏–≥–∞—Ü–∏–∏)" rows={bonds} setRows={setBonds} />
                <EditableTable title="–ë–ª–æ–∫ —Ä–æ—Å—Ç–∞ (–ê–∫—Ü–∏–∏)" rows={stocks} setRows={setStocks} />
              </div>

            </div>
          )}

          {tab === "forecast" && (
            <div className="px-4 animate-fade-in">
               <div className="bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden">
                  <table className="w-full text-xs text-left">
                    <thead className="bg-zinc-950 text-zinc-400 uppercase font-medium">
                      <tr>
                        <th className="px-4 py-3">–ì–æ–¥</th>
                        <th className="px-4 py-3">–ö–∞–ø–∏—Ç–∞–ª</th>
                        <th className="px-4 py-3 text-right">–î–æ—Ö–æ–¥</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-zinc-800">
                      {forecast.map((r) => (
                        <tr key={r.year} className="text-zinc-300">
                          <td className="px-4 py-3 font-mono text-zinc-500">{r.year}</td>
                          <td className="px-4 py-3 font-medium">{cf.format(r.fv)}</td>
                          <td className="px-4 py-3 text-right text-green-400">+{cf.format(r.income)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
               </div>
               <div className="text-center mt-6">
                  <button onClick={() => setTab("calc")} className="text-indigo-400 text-sm hover:text-indigo-300">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
               </div>
            </div>
          )}

          <div className="h-10"></div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
