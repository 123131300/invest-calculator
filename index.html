<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Инвест-калькулятор (мини-эпс)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            zinc: { 750:'#27272a', 850:'#202022', 900:'#18181b', 950:'#09090b' }
          }
        }
      }
    }
  </script>

  <!-- React / Babel / Supabase / Telegram WebApp -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body{ background:#09090b; color:#e4e4e7; -webkit-tap-highlight-color:transparent }
    ::-webkit-scrollbar{ width:6px; height:6px }
    ::-webkit-scrollbar-track{ background:#18181b }
    ::-webkit-scrollbar-thumb{ background:#4f46e5; border-radius:3px }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0 }
  </style>
</head>
<body class="bg-zinc-950">

  <div id="root"></div>

  <script type="text/babel">
    /**************  НАСТРОЙКИ  ****************/
    const SUPABASE_URL = 'https://omxvlwcjtijbjuhjadgj.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_aNBhpvGpkfEn1HtaPzEE3w_o7TmgioM';
    /*******************************************/

    const { useState, useEffect, useMemo } = React;
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const tg = window.Telegram?.WebApp;

    // Telegram init
    try { tg?.ready(); tg?.expand(); } catch(e) {}

    // helpers
    const cf = new Intl.NumberFormat('ru-RU', { style:'currency', currency:'RUB', maximumFractionDigits:0 });
    const pf = new Intl.NumberFormat('ru-RU', { style:'percent', maximumFractionDigits:1 });

    const PERIODS = [
      { key:'monthly',   label:'Раз в месяц',  perYear:12 },
      { key:'quarterly', label:'Раз в квартал', perYear:4 },
      { key:'yearly',    label:'Раз в год',     perYear:1 },
      { key:'weekly',    label:'Раз в неделю',  perYear:52 },
      { key:'daily',     label:'Ежедневно',     perYear:365 }
    ];

    function gcd(a,b){ return b===0?Math.abs(a):gcd(b,a%b) }
    function lcm(a,b){ return Math.abs(a*b)/gcd(a,b) }

    function simulateFV({ principal, apr, years, contribution, contribPerYear, compoundPerYear, reinvest }) {
      const stepsPerYear = lcm(Math.max(1,compoundPerYear), Math.max(1,contribPerYear));
      const totalSteps   = Math.round(stepsPerYear * years);
      const stepRate     = Math.pow(1+apr, 1/Math.max(1,compoundPerYear)) - 1;
      const sContrib     = stepsPerYear / Math.max(1,contribPerYear);
      const sCompound    = stepsPerYear / Math.max(1,compoundPerYear);

      let balance = Math.max(0, principal);
      let paidIn  = Math.max(0, principal);
      let incomeWithdrawn = 0;

      for (let s=1; s<=totalSteps; s++){
        if (contribPerYear>0 && s % sContrib === 0) { balance += contribution; paidIn += contribution; }
        if (compoundPerYear>0 && s % sCompound === 0) {
          const interest = balance * stepRate;
          if (reinvest) balance += interest; else incomeWithdrawn += interest;
        }
      }
      const fv = balance;
      const income = reinvest ? fv - paidIn : incomeWithdrawn;
      return { fv, paidIn, income };
    }

    function fvMinusTarget(variable, mode, p){
      const base = { principal:p.principal, apr:p.apr, years:p.years, contribution:p.contribution, contribPerYear:p.contribPerYear, compoundPerYear:p.compoundPerYear, reinvest:p.reinvest };
      if (mode==='apr')       return simulateFV({ ...base, apr:Math.max(0,variable) }).fv        - p.target;
      if (mode==='years')     return simulateFV({ ...base, years:Math.max(0,variable) }).fv      - p.target;
      if (mode==='contrib')   return simulateFV({ ...base, contribution:Math.max(0,variable) }).fv - p.target;
      if (mode==='principal') return simulateFV({ ...base, principal:Math.max(0,variable) }).fv   - p.target;
      return 0;
    }
    function solveBisection(f, lo, hi, eps=1e-7, maxIter=200){
      let flo=f(lo), fhi=f(hi), guard=0;
      while(flo*fhi>0 && guard<30){ hi = hi*2+1; fhi=f(hi); guard++; if(!isFinite(hi)) return null; }
      if (Math.abs(flo)<eps) return lo; if (Math.abs(fhi)<eps) return hi;
      for (let i=0;i<maxIter;i++){ const m=(lo+hi)/2, fm=f(m);
        if (Math.abs(fm)<eps) return m;
        if (flo*fm<0){ hi=m; fhi=fm; } else { lo=m; flo=fm; }
      }
      return (lo+hi)/2;
    }

    function Toggle({ checked, onChange, label }){
      return (
        <label className="flex items-center gap-3 cursor-pointer select-none">
          <button type="button" role="switch" aria-checked={checked}
            onClick={()=>onChange(!checked)}
            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${checked?'bg-indigo-600':'bg-zinc-600'}`}>
            <span className={`inline-block h-4 w-4 transform rounded-full bg-white shadow transition ${checked?'translate-x-6':'translate-x-1'}`}/>
          </button>
          <span className="text-zinc-200 text-sm">{label}</span>
        </label>
      );
    }
    function Segmented({ options, value, onChange }){
      return (
        <div className="inline-flex rounded-2xl border border-zinc-800 p-1 bg-zinc-900">
          {options.map(o=>(
            <button key={o.key} type="button" onClick={()=>onChange(o.key)}
              className={`px-3 py-1.5 rounded-xl text-sm font-medium transition ${value===o.key?'bg-indigo-600 text-white':'text-zinc-400 hover:text-zinc-200'}`}>
              {o.label}
            </button>
          ))}
        </div>
      );
    }
    function SliderRow({ label, value, setValue, min, max, step=1, formatRight, disabled=false }){
      return (
        <div className="flex flex-col gap-1">
          <div className="text-sm text-zinc-400">{label}</div>
          <div className="flex items-center gap-3">
            <input type="range" min={min} max={max} step={step} value={Number.isFinite(value)?value:0}
              onChange={e=>setValue(Number(e.target.value))} disabled={disabled}
              className="flex-1 h-2 rounded-full bg-zinc-700 accent-indigo-600"/>
            <input type="number" className="w-36 bg-zinc-900 border border-zinc-700 rounded-xl px-3 py-2 text-zinc-100"
              value={Number.isFinite(value)?value:0} onChange={e=>setValue(Number(e.target.value))}
              step={step} min={min} max={max} disabled={disabled}/>
          </div>
          <div className="text-xs text-zinc-500">{formatRight(value)}</div>
        </div>
      );
    }
    function EditableTable({ title, rows, setRows, colorClass='text-zinc-300' }){
      const sumW = rows.reduce((a,b)=>a+(Number.isFinite(b.w)?b.w:0),0);
      function update(i,k,v){
        const cp=[...rows];
        if (['w','r','s'].includes(k)){ const num=Number(v); cp[i]={...cp[i],[k]:isFinite(num)?num:0}; }
        else cp[i]={...cp[i],[k]:String(v)};
        setRows(cp);
      }
      function add(){ setRows([...rows,{ticker:'NEW',w:0.1,r:0.15,s:0.2}]); }
      function remove(i){ const cp=[...rows]; cp.splice(i,1); setRows(cp); }
      function normalize(){ const total=rows.reduce((a,b)=>a+b.w,0)||1; setRows(rows.map(r=>({...r,w:Number((r.w/total).toFixed(2))}))); }
      return (
        <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-4">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm font-semibold text-zinc-100">{title}</div>
            <div className={`text-xs ${Math.abs(sumW-1)>0.02?'text-red-400':'text-green-400'}`}>Доли: {(sumW*100).toFixed(0)}%</div>
          </div>
          <div className="space-y-2">
            {rows.map((row,idx)=>(
              <div key={idx} className="grid grid-cols-12 gap-2 items-center">
                <input value={row.ticker} onChange={e=>update(idx,'ticker',e.target.value)}
                  className="col-span-4 bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-xs text-white"/>
                <input type="number" value={Number(row.w.toFixed(2))} step={0.05} min={0} max={1}
                  onChange={e=>update(idx,'w',e.target.value)}
                  className="col-span-2 bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-xs text-center text-white"/>
                <div className="col-span-3 relative">
                  <input type="number" value={Math.round(row.r*100)} step={1}
                    onChange={e=>update(idx,'r',Number(e.target.value)/100)}
                    className="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-xs text-center text-white"/>
                  <span className="absolute right-2 top-1.5 text-[10px] text-zinc-500">%</span>
                </div>
                <input type="number" value={row.s} step={0.01} min={0}
                  onChange={e=>update(idx,'s',e.target.value)}
                  className="col-span-2 bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-xs text-center text-white"/>
                <button onClick={()=>remove(idx)} className="col-span-1 text-zinc-600 hover:text-red-400">✕</button>
              </div>
            ))}
          </div>
          <div className="flex gap-2 mt-3">
            <button onClick={add} className="flex-1 py-2 bg-zinc-800 text-zinc-300 rounded-lg text-xs hover:bg-zinc-700">Добавить</button>
            <button onClick={normalize} className={`flex-1 py-2 border border-zinc-700 rounded-lg text-xs hover:bg-zinc-800 ${colorClass}`}>Нормализовать</button>
          </div>
        </div>
      );
    }

    function App(){
      // user id (если нет Telegram — делаем локальный)
      const localId = (()=>{ const k='demo_uid'; const ex=localStorage.getItem(k); if(ex) return ex; const v=String(1e9*Math.random()|0); localStorage.setItem(k,v); return v })();
      const userId = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : localId;
      const LS_KEY = 'ai-invest-calc-v1';

      // вкладки/режим
      const [tab,setTab] = useState('calc');       // calc | forecast
      const [mode,setMode] = useState('contrib');  // income | rate | principal | term | contrib

      // базовые
      const [target,setTarget] = useState(1_000_000);
      const [principal,setPrincipal] = useState(100_000);
      const [years,setYears] = useState(5);
      const [contrib,setContrib] = useState(10_000);

      // частоты/реинвест
      const [reinvest,setReinvest] = useState(true);
      const [compoundKey,setCompoundKey] = useState('monthly');
      const [contribKey,setContribKey]   = useState('monthly');
      const compoundPerYear = PERIODS.find(p=>p.key===compoundKey)?.perYear ?? 12;
      const contribPerYear  = PERIODS.find(p=>p.key===contribKey)?.perYear ?? 12;

      // портфель
      const [usePortfolioReturn,setUsePortfolioReturn] = useState(true);
      const [bondShare,setBondShare] = useState(0.7);
      const [rho,setRho] = useState(0.2);
      const [bonds,setBonds] = useState([
        { ticker:"ОФЗ-26238", w:0.35, r:0.11, s:0.04 },
        { ticker:"ОФЗ-26212", w:0.35, r:0.10, s:0.04 },
        { ticker:"GAZP-OBL",  w:0.15, r:0.12, s:0.06 },
        { ticker:"SBER-OBL",  w:0.15, r:0.12, s:0.06 },
      ]);
      const [stocks,setStocks] = useState([
        { ticker:"SBER", w:0.20, r:0.22, s:0.30 },
        { ticker:"GAZP", w:0.20, r:0.20, s:0.35 },
        { ticker:"YNDX", w:0.20, r:0.24, s:0.35 },
        { ticker:"LKOH", w:0.20, r:0.20, s:0.28 },
        { ticker:"MGNT", w:0.20, r:0.18, s:0.25 },
      ]);
      const [manualAprPercent,setManualAprPercent] = useState(12);

      // загрузка сохранений
      const [loading,setLoading] = useState(true);
      useEffect(()=>{
        (async ()=>{
          try {
            const { data } = await sb.from('user_saves').select('data').eq('user_id', userId).maybeSingle();
            let state = data?.data;
            if (!state) { const raw = localStorage.getItem(LS_KEY); if (raw) state = JSON.parse(raw); }
            if (state){
              const apply = (k, fn) => { if (k in state) fn(state[k]) }
              apply('mode', setMode);
              apply('target', setTarget);
              apply('principal', setPrincipal);
              apply('years', setYears);
              apply('contrib', setContrib);
              apply('reinvest', setReinvest);
              apply('compoundKey', setCompoundKey);
              apply('contribKey', setContribKey);
              apply('usePortfolioReturn', setUsePortfolioReturn);
              apply('bondShare', setBondShare);
              apply('rho', setRho);
              apply('manualAprPercent', setManualAprPercent);
              apply('bonds', setBonds);
              apply('stocks', setStocks);
            }
          } catch(e){} finally { setLoading(false); }
        })();
      },[]);

      // автосейв
      const snapshot = { mode,target,principal,years,contrib,reinvest,compoundKey,contribKey,usePortfolioReturn,bondShare,rho,manualAprPercent,bonds,stocks };
      useEffect(()=>{
        if (loading) return;
        const t=setTimeout(async ()=>{
          localStorage.setItem(LS_KEY, JSON.stringify(snapshot));
          try { await sb.from('user_saves').upsert({ user_id:userId, data:snapshot }); } catch(e){}
        }, 800);
        return ()=>clearTimeout(t);
      }, [JSON.stringify(snapshot), loading]);

      // метрики
      function totals(rows){ const ret=rows.reduce((a,r)=>a+r.w*r.r,0); const sigma=Math.sqrt(rows.reduce((a,r)=>a+Math.pow(r.w*r.s,2),0)); return {ret, sigma}; }
      const bondsTot  = useMemo(()=>totals(bonds),[bonds]);
      const stocksTot = useMemo(()=>totals(stocks),[stocks]);
      const portRet   = bondShare*bondsTot.ret + (1-bondShare)*stocksTot.ret;
      const portSigma = Math.sqrt(Math.pow(bondShare*bondsTot.sigma,2)+Math.pow((1-bondShare)*stocksTot.sigma,2)+2*bondShare*(1-bondShare)*rho*bondsTot.sigma*stocksTot.sigma);
      const apr = usePortfolioReturn ? Math.max(0,portRet) : Math.max(0,manualAprPercent/100);

      // расчёты / решатели
      const result = useMemo(()=>{
        const base = { principal, apr, years, contribution:contrib, contribPerYear, compoundPerYear, reinvest };
        let computed = simulateFV(base);
        let computedValue = null;

        if (mode==='income'){ computedValue = computed.income; }
        if (mode==='contrib'){
          const x = solveBisection(v=>fvMinusTarget(v,'contrib',{...base,target,apr}), 0, Math.max(1,target*2));
          computed = simulateFV({ ...base, contribution:x??0 }); computedValue = x??0;
        }
        if (mode==='principal'){
          const x = solveBisection(v=>fvMinusTarget(v,'principal',{...base,target,apr}), 0, Math.max(1,target));
          computed = simulateFV({ ...base, principal:x??0 }); computedValue = x??0;
        }
        if (mode==='rate'){
          const x = solveBisection(v=>fvMinusTarget(v,'apr',{...base,target,apr:v}), 0, 10);
          computed = simulateFV({ ...base, apr:x??0 }); computedValue = (x??0)*100;
        }
        if (mode==='term'){
          const x = solveBisection(v=>fvMinusTarget(v,'years',{...base,target,years:v}), 0, 100);
          computed = simulateFV({ ...base, years:x??0 }); computedValue = x??0;
        }
        return { ...computed, computedValue };
      },[mode,target,principal,years,apr,contrib,reinvest,compoundPerYear,contribPerYear]);

      const progress = target>0 ? Math.min(1, result.fv/target) : 0;

      const forecast = useMemo(()=>{
        const yrs = Math.max(0, Math.min(50, Math.round(years)));
        const rows = [];
        for (let y=0; y<=yrs; y++){
          const r = simulateFV({ principal, apr, years:y, contribution:contrib, contribPerYear, compoundPerYear, reinvest });
          rows.push({ year:y, ...r });
        }
        return rows;
      },[principal,apr,years,contrib,contribPerYear,compoundPerYear,reinvest]);

      const headline = (()=>{
        if (mode==='income' || mode==='contrib' || mode==='principal') return cf.format(Math.max(0, result.computedValue??0));
        if (mode==='rate') return `${(result.computedValue??0).toFixed(2)}% годовых`;
        if (mode==='term') return `${(result.computedValue??0).toFixed(2)} лет`;
        return '—';
      })();
      const subTitleMap = {
        income:'Расчётного дохода',
        rate:'Необходимая ставка',
        principal:'Необходимый стартовый капитал',
        term:'Необходимый срок',
        contrib:'Необходимый размер пополнений'
      };

      if (loading) return <div className="flex h-screen items-center justify-center text-zinc-500">Загрузка…</div>;

      return (
        <div className="min-h-screen bg-zinc-950 text-zinc-50 pb-10">
          <div className="max-w-6xl mx-auto px-4 pt-5">
            <div className="flex items-center justify-between mb-5">
              <h1 className="text-2xl font-bold">Инвестиционный калькулятор сложного процента с пополнением</h1>
              <Segmented options={[{key:'calc',label:'Калькулятор'},{key:'forecast',label:'Прогноз капитала'}]} value={tab} onChange={setTab}/>
            </div>

            {tab==='calc' && (
              <>
                <div className="grid md:grid-cols-2 gap-6">
                  <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-5">
                    <div className="text-sm text-zinc-400 mb-2">Вычислить</div>
                    <div className="flex flex-col gap-2">
                      {[
                        {k:'income',t:'Доход'},
                        {k:'rate',t:'Ставку'},
                        {k:'principal',t:'Стартовый капитал'},
                        {k:'term',t:'Срок достижения цели'},
                        {k:'contrib',t:'Размер пополнений'},
                      ].map(o=>(
                        <label key={o.k} className="inline-flex items-center gap-3 cursor-pointer">
                          <input type="radio" name="mode" className="h-4 w-4 accent-indigo-600" checked={mode===o.k} onChange={()=>setMode(o.k)}/>
                          <span className="text-sm">{o.t}</span>
                        </label>
                      ))}
                    </div>

                    <div className="mt-4"><Toggle checked={reinvest} onChange={setReinvest} label="Реинвестировать доход"/></div>

                    <div className="mt-4">
                      <div className="text-sm text-zinc-400 mb-1">Период реинвестирования</div>
                      <Segmented options={PERIODS.map(p=>({key:p.key,label:p.label}))} value={compoundKey} onChange={setCompoundKey}/>
                    </div>
                    <div className="mt-3">
                      <div className="text-sm text-zinc-400 mb-1">Периодичность пополнений</div>
                      <Segmented options={PERIODS.map(p=>({key:p.key,label:p.label}))} value={contribKey} onChange={setContribKey}/>
                    </div>

                    <div className="mt-5">
                      <Toggle checked={usePortfolioReturn} onChange={setUsePortfolioReturn} label="Использовать доходность портфеля (вместо ручной ставки)"/>
                    </div>
                  </div>

                  <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-5">
                    <div className="text-sm text-zinc-400">Результат</div>
                    <div className="text-4xl font-semibold mt-1">{headline}</div>
                    <div className="text-sm text-zinc-400 mt-1">{subTitleMap[mode]}</div>

                    <div className="grid grid-cols-2 gap-3 mt-4 text-sm">
                      <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Итоговая сумма</div><div className="font-semibold">{cf.format(Math.max(0,result.fv))}</div></div>
                      <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Всего внесено</div><div className="font-semibold">{cf.format(Math.max(0,result.paidIn))}</div></div>
                      <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Доход</div><div className="font-semibold">{cf.format(Math.max(0,result.income))}</div></div>
                      <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Эффективная доля дохода</div><div className="font-semibold">{result.fv>0?((result.income/result.fv)*100).toFixed(1)+'%':'—'}</div></div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 mt-4 text-sm">
                      <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Доходность портфеля (год)</div><div className="font-semibold">{pf.format(portRet)}</div></div>
                      <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Риск портфеля σ</div><div className="font-semibold">{(portSigma*100).toFixed(1)}%</div></div>
                    </div>

                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-zinc-400 mb-1"><span>Прогресс к цели</span><span>{pf.format(progress)}</span></div>
                      <div className="h-3 rounded-full bg-zinc-800 overflow-hidden"><div className="h-full bg-indigo-600" style={{width:`${progress*100}%`}}></div></div>
                    </div>
                  </div>
                </div>

                <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-5 mt-6">
                  <div className="mb-3 text-base font-semibold">Быстрые ползунки</div>
                  <div className="grid md:grid-cols-2 gap-6">
                    <SliderRow label="Ваша цель, ₽" value={target} setValue={setTarget} min={0} max={Math.max(1_000_000, target, principal + contrib*12*Math.max(1,years))} step={5000} formatRight={n=>cf.format(n)}/>
                    <SliderRow label="Стартовый капитал, ₽" value={principal} setValue={setPrincipal} min={0} max={Math.max(500_000, principal, target)} step={5000} formatRight={n=>cf.format(n)}/>
                    <SliderRow label="Срок инвестирования, лет" value={years} setValue={setYears} min={0} max={50} step={0.1} formatRight={n=>`${n.toFixed(1)} лет`}/>
                    <SliderRow label="Ставка, % годовых" value={manualAprPercent} setValue={setManualAprPercent} min={0} max={50} step={0.1} formatRight={n=>`${n.toFixed(1)}% / год`} disabled={usePortfolioReturn}/>
                    <SliderRow label="Размер пополнений, ₽" value={contrib} setValue={setContrib} min={0} max={Math.max(50_000, contrib, Math.round(target/Math.max(12,years*12)))} step={500} formatRight={n=>cf.format(n)} disabled={mode==='contrib'}/>
                  </div>
                </div>

                <div className="grid lg:grid-cols-3 gap-6 mt-6">
                  <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-5">
                    <div className="text-base font-semibold mb-3">Аллокация</div>
                    <SliderRow label="Доля облигаций, %" value={Math.round(bondShare*100)} setValue={v=>setBondShare(Math.min(100,Math.max(0,v))/100)} min={0} max={100} step={1} formatRight={n=>`${n.toFixed(0)}% облигации / ${(100-n).toFixed(0)}% акции`}/>
                    <div className="mt-4"></div>
                    <SliderRow label="Корреляция облигации–акции, ρ" value={rho} setValue={setRho} min={-0.9} max={0.9} step={0.01} formatRight={n=>`${(n*100).toFixed(0)}%`}/>
                    <div className="mt-3 text-sm text-zinc-500">Доходность облигаций: {pf.format(bondsTot.ret)} · Риск: {(bondsTot.sigma*100).toFixed(1)}%</div>
                    <div className="text-sm text-zinc-500">Доходность акций: {pf.format(stocksTot.ret)} · Риск: {(stocksTot.sigma*100).toFixed(1)}%</div>
                  </div>
                  <div className="lg:col-span-2 flex flex-col gap-6">
                    <EditableTable title="Консервативный блок (облигации)" rows={bonds} setRows={setBonds} colorClass="text-blue-400"/>
                    <EditableTable title="Блок роста (акции)" rows={stocks} setRows={setStocks} colorClass="text-purple-400"/>
                  </div>
                </div>
              </>
            )}

            {tab==='forecast' && (
              <div className="rounded-2xl border border-zinc-800 bg-zinc-900 p-5">
                <div className="mb-4 text-xl font-semibold">Шаг 5. Прогноз капитала</div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                  <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Ожидаемая доходность (год)</div><div className="font-semibold">{pf.format(apr)}</div></div>
                  <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Ставка за месяц</div><div className="font-semibold">{((Math.pow(1+apr,1/12)-1)*100).toFixed(1)}%</div></div>
                  <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Реинвест</div><div className="font-semibold">{reinvest?'вкл.':'выкл.'}</div></div>
                  <div className="rounded-xl border border-zinc-800 p-3"><div className="text-zinc-400">Периоды/год</div><div className="font-semibold">реинв: {compoundPerYear} · взносы: {contribPerYear}</div></div>
                </div>
                <div className="overflow-auto rounded-xl border border-zinc-800">
                  <table className="min-w-full text-sm">
                    <thead className="bg-zinc-950 text-zinc-400">
                      <tr><th className="px-4 py-2 text-left">Год</th><th className="px-4 py-2 text-left">Итог (₽)</th><th className="px-4 py-2 text-left">Внесено (₽)</th><th className="px-4 py-2 text-left">Доход (₽)</th></tr>
                    </thead>
                    <tbody>
                      {forecast.map(r=>(
                        <tr key={r.year} className="odd:bg-zinc-900 even:bg-zinc-900/70">
                          <td className="px-4 py-1.5">{r.year}</td>
                          <td className="px-4 py-1.5">{cf.format(Math.max(0,r.fv))}</td>
                          <td className="px-4 py-1.5">{cf.format(Math.max(0,r.paidIn))}</td>
                          <td className="px-4 py-1.5">{cf.format(Math.max(0,r.income))}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            <div className="text-xs text-zinc-500 mt-6">
              Пояснение: риск блоков оценивается как корень из суммы квадратов (независимость внутри блока).
              Совокупный риск портфеля учитывает корреляцию между блоками ρ.
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
