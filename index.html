<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ò–Ω–≤–µ—Å—Ç-–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            zinc: { 750: '#27272a', 850: '#202022', 900: '#18181b', 950: '#09090b' }
          }
        }
      }
    }
  </script>
  
  <!-- React & Libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* –°–∫—Ä–æ–ª–ª–±–∞—Ä –∏ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }
    body { -webkit-tap-highlight-color: transparent; background-color: #09090b; color: #e4e4e7; }
    input[type="number"]::-webkit-inner-spin-button, 
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    // ==========================================
    // üõë –í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï –ù–ò–ñ–ï
    // ==========================================
    const SUPABASE_URL = 'https://omxvlwcjtijbjuhjadgj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_aNBhpvGpkfEn1HtaPzEE3w_o7TmgioM';
    // ==========================================

    const { useState, useMemo, useEffect } = React;
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const tg = window.Telegram.WebApp;

    tg.expand(); 

    // --- –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê –ò –£–¢–ò–õ–ò–¢–´ ---
    const cf = new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB", maximumFractionDigits: 0 });
    const pf = new Intl.NumberFormat("ru-RU", { style: "percent", maximumFractionDigits: 1 });

    function gcd(a, b) { return b === 0 ? Math.abs(a) : gcd(b, a % b); }
    function lcm(a, b) { return Math.abs(a * b) / gcd(a, b); }

    function simulateFV({ principal, apr, years, contribution, contribPerYear, compoundPerYear, reinvest }) {
      const stepsPerYear = lcm(Math.max(1, compoundPerYear), Math.max(1, contribPerYear));
      const totalSteps = Math.round(stepsPerYear * years);
      const stepRate = Math.pow(1 + apr, 1 / Math.max(1, compoundPerYear)) - 1;
      const stepIsContribEvery = stepsPerYear / Math.max(1, contribPerYear);
      const stepIsCompoundEvery = stepsPerYear / Math.max(1, compoundPerYear);

      let balance = Math.max(0, principal);
      let paidIn = Math.max(0, principal);
      let incomeWithdrawn = 0;

      for (let s = 1; s <= totalSteps; s++) {
        if (contribPerYear > 0 && s % stepIsContribEvery === 0) {
          balance += contribution;
          paidIn += contribution;
        }
        if (compoundPerYear > 0 && s % stepIsCompoundEvery === 0) {
          const interest = balance * stepRate;
          if (reinvest) balance += interest; else incomeWithdrawn += interest;
        }
      }
      return { fv: balance, paidIn, income: reinvest ? balance - paidIn : incomeWithdrawn };
    }

    // --- –ö–û–ú–ü–û–ù–ï–ù–¢–´ UI ---

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å (Toggle)
    function Toggle({ checked, onChange, label }) {
      return (
        <label className="flex items-center gap-3 cursor-pointer select-none py-1">
          <div className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200 ${checked ? "bg-indigo-500" : "bg-zinc-600"}`}>
            <span className={`inline-block h-3 w-3 transform rounded-full bg-white shadow transition ${checked ? "translate-x-5" : "translate-x-1"}`} />
          </div>
          <input type="checkbox" className="hidden" checked={checked} onChange={(e) => onChange(e.target.checked)} />
          <span className="text-sm text-zinc-300">{label}</span>
        </label>
      );
    }

    // –í–∫–ª–∞–¥–∫–∏ (Segmented Control)
    function Segmented({ options, value, onChange }) {
      return (
        <div className="grid grid-cols-2 gap-1 p-1 bg-zinc-900 rounded-xl border border-zinc-800">
          {options.map(opt => (
            <button key={opt.key} type="button" onClick={() => onChange(opt.key)} 
              className={`py-2 text-sm font-medium rounded-lg transition ${value === opt.key ? "bg-indigo-600 text-white shadow-lg" : "text-zinc-400 hover:text-zinc-200"}`}>
              {opt.label}
            </button>
          ))}
        </div>
      );
    }

    // –°–ª–∞–π–¥–µ—Ä —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ (SliderRow)
    function SliderRow({ label, value, setValue, min, max, step = 1, formatFn, suffix = "" }) {
      return (
        <div className="mb-6">
          <div className="flex justify-between items-center mb-2">
             <span className="text-sm text-zinc-400 font-medium">{label}</span>
             <div className="relative">
                <input 
                  type="number" 
                  value={value} 
                  onChange={(e) => setValue(Number(e.target.value))}
                  className="w-32 bg-zinc-900 border border-zinc-700 rounded-lg px-2 py-1 text-right text-zinc-100 text-sm focus:outline-none focus:border-indigo-500 transition"
                />
                {suffix && <span className="absolute right-8 top-1 text-zinc-500 text-xs pointer-events-none">{suffix}</span>}
             </div>
          </div>
          <input type="range" min={min} max={max} step={step} value={value} 
            onChange={(e) => setValue(Number(e.target.value))} 
            className="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
        </div>
      );
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è —Ç–∞–±–ª–∏—Ü–∞ (EditableTable)
    function EditableTable({ title, rows, setRows, colorClass = "text-indigo-400" }) {
      const sumW = rows.reduce((a, b) => a + (Number.isFinite(b.w) ? b.w : 0), 0);
      
      function update(idx, key, val) {
        const copy = [...rows];
        if (key === "w" || key === "r" || key === "s") {
          const num = Number(val);
          copy[idx] = { ...copy[idx], [key]: isFinite(num) ? num : 0 };
        } else {
          copy[idx] = { ...copy[idx], [key]: String(val) };
        }
        setRows(copy);
      }
      function add() { setRows([...rows, { ticker: "NEW", w: 0.1, r: 0.15, s: 0.2 }]); }
      function remove(i) { const copy = [...rows]; copy.splice(i, 1); setRows(copy); }
      function normalize() {
        const total = rows.reduce((a, b) => a + b.w, 0) || 1;
        setRows(rows.map(r => ({ ...r, w: Number((r.w / total).toFixed(2)) })));
      }

      return (
        <div className="rounded-xl border border-zinc-800 bg-zinc-900/50 p-4 mb-4">
          <div className="flex items-center justify-between mb-3">
            <div className="text-sm font-bold text-zinc-200">{title}</div>
            <div className={`text-xs font-mono ${Math.abs(sumW - 1) > 0.02 ? 'text-red-400' : 'text-green-400'}`}>
              –î–æ–ª–∏: {(sumW * 100).toFixed(0)}%
            </div>
          </div>
          <div className="space-y-2">
            {rows.map((row, idx) => (
              <div key={idx} className="grid grid-cols-12 gap-2 items-center">
                <div className="col-span-5">
                  <input value={row.ticker} onChange={e => update(idx, "ticker", e.target.value)} 
                  className="w-full bg-zinc-800 border border-zinc-700 rounded px-2 py-1.5 text-xs text-white focus:border-indigo-500 outline-none" placeholder="–¢–∏–∫–µ—Ä" />
                </div>
                <div className="col-span-3">
                   <input type="number" value={Number((row.w).toFixed(2))} step={0.05} onChange={e => update(idx, "w", e.target.value)} 
                     className="w-full bg-zinc-800 border border-zinc-700 rounded px-1 py-1.5 text-xs text-white text-center focus:border-indigo-500 outline-none" />
                </div>
                <div className="col-span-3 relative">
                   <input type="number" value={Math.round(row.r * 100)} step={1} onChange={e => update(idx, "r", Number(e.target.value)/100)} 
                     className="w-full bg-zinc-800 border border-zinc-700 rounded px-1 py-1.5 text-xs text-white text-center focus:border-indigo-500 outline-none" />
                   <span className="absolute right-1 top-1.5 text-[10px] text-zinc-500">%</span>
                </div>
                <button onClick={() => remove(idx)} className="col-span-1 flex justify-center text-zinc-600 hover:text-red-400">‚úï</button>
              </div>
            ))}
          </div>
          <div className="flex gap-2 mt-3 pt-2 border-t border-zinc-800">
            <button onClick={add} className="flex-1 py-2 bg-zinc-800 text-zinc-300 rounded-lg text-xs hover:bg-zinc-700 transition">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onClick={normalize} className={`flex-1 py-2 border border-zinc-700 ${colorClass} rounded-lg text-xs hover:bg-zinc-800 transition`}>–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      );
    }

    // --- –ì–õ–ê–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
    function App() {
      const userId = tg.initDataUnsafe?.user?.id || 777; 
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [tab, setTab] = useState("calc");

      // –°–æ—Å—Ç–æ—è–Ω–∏—è (–í–°–ï –†–ï–î–ê–ö–¢–ò–†–£–ï–ú–´–ï)
      const [target, setTarget] = useState(10000000);
      const [principal, setPrincipal] = useState(100000);
      const [years, setYears] = useState(10);
      const [contrib, setContrib] = useState(10000);
      const [reinvest, setReinvest] = useState(true);
      const [bondShare, setBondShare] = useState(0.7);

      const [bonds, setBonds] = useState([
        { ticker: "–û–§–ó-26238", w: 0.35, r: 0.11, s: 0.04 },
        { ticker: "–û–§–ó-26212", w: 0.35, r: 0.10, s: 0.04 },
        { ticker: "GAZP-OBL",  w: 0.15, r: 0.12, s: 0.06 },
        { ticker: "SBER-OBL",  w: 0.15, r: 0.12, s: 0.06 },
      ]);
      const [stocks, setStocks] = useState([
        { ticker: "SBER", w: 0.20, r: 0.22, s: 0.30 },
        { ticker: "GAZP", w: 0.20, r: 0.20, s: 0.35 },
        { ticker: "YNDX", w: 0.20, r: 0.24, s: 0.35 },
        { ticker: "LKOH", w: 0.20, r: 0.20, s: 0.28 },
        { ticker: "MGNT", w: 0.20, r: 0.18, s: 0.25 },
      ]);

      // –ó–∞–≥—Ä—É–∑–∫–∞
      useEffect(() => {
        async function load() {
          const { data } = await supabase.from('user_saves').select('data').eq('user_id', userId).single();
          if (data?.data) {
            const s = data.data;
            if (s.target) setTarget(s.target);
            if (s.principal) setPrincipal(s.principal);
            if (s.years) setYears(s.years);
            if (s.contrib) setContrib(s.contrib);
            if (s.bondShare !== undefined) setBondShare(s.bondShare);
            if (s.bonds) setBonds(s.bonds);
            if (s.stocks) setStocks(s.stocks);
            if (s.reinvest !== undefined) setReinvest(s.reinvest);
          }
          setLoading(false);
        }
        load();
      }, []);

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      useEffect(() => {
        if (loading) return;
        const timer = setTimeout(async () => {
          setSaving(true);
          const saveData = { target, principal, years, contrib, bondShare, bonds, stocks, reinvest };
          await supabase.from('user_saves').upsert({ user_id: userId, data: saveData });
          setSaving(false);
        }, 1500);
        return () => clearTimeout(timer);
      }, [target, principal, years, contrib, bondShare, bonds, stocks, reinvest]);

      // –†–∞—Å—á–µ—Ç—ã
      const getStats = (rows) => {
        const ret = rows.reduce((a, r) => a + r.w * r.r, 0);
        const sigma = Math.sqrt(rows.reduce((a, r) => a + Math.pow(r.w * r.s, 2), 0));
        return { ret, sigma };
      };
      const bondsStat = useMemo(() => getStats(bonds), [bonds]);
      const stocksStat = useMemo(() => getStats(stocks), [stocks]);
      const rho = 0.2; 
      const portRet = bondShare * bondsStat.ret + (1 - bondShare) * stocksStat.ret;
      
      const result = useMemo(() => {
        return simulateFV({
          principal,
          apr: portRet,
          years,
          contribution: contrib,
          contribPerYear: 12,
          compoundPerYear: 12,
          reinvest
        });
      }, [principal, portRet, years, contrib, reinvest]);

      const progress = target > 0 ? Math.min(1, result.fv / target) : 0;
      const forecast = useMemo(() => {
        const rows = [];
        for (let y = 0; y <= years; y++) {
          const r = simulateFV({ principal, apr: portRet, years: y, contribution: contrib, contribPerYear: 12, compoundPerYear: 12, reinvest });
          rows.push({ year: y, ...r });
        }
        return rows;
      }, [principal, portRet, years, contrib, reinvest]);

      if (loading) return <div className="flex h-screen items-center justify-center text-zinc-500 bg-black">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

      return (
        <div className="min-h-screen bg-[#09090b] pb-10 font-sans">
          
          {/* –®–ê–ü–ö–ê (–§–ò–û–õ–ï–¢–û–í–ê–Ø) */}
          <div className="bg-indigo-600 px-6 py-6 rounded-b-[24px] shadow-2xl shadow-indigo-900/20 mb-6 relative">
            <div className="flex justify-between items-start mb-2">
                <div className="text-indigo-200 text-[10px] uppercase tracking-widest font-bold">–í–∞—à –∫–∞–ø–∏—Ç–∞–ª —á–µ—Ä–µ–∑ {Math.round(years)} –ª–µ—Ç</div>
                <div className="text-[10px] text-indigo-300 animate-pulse">{saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–ì–æ—Ç–æ–≤–æ"}</div>
            </div>
            <div className="text-4xl font-bold text-white mb-6 tracking-tight">{cf.format(result.fv)}</div>
            
            <div className="flex justify-between text-[10px] text-indigo-100 mb-1 font-medium">
                <span>–ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏ {cf.format(target)}</span>
                <span>{(progress * 100).toFixed(0)}%</span>
            </div>
            <div className="h-1.5 bg-indigo-950/30 rounded-full overflow-hidden mb-5">
                <div className="h-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-500" style={{width: `${progress*100}%`}}></div>
            </div>

            <div className="flex justify-between border-t border-indigo-500/30 pt-3">
                <div>
                    <div className="text-[10px] text-indigo-200">–í–ª–æ–∂–µ–Ω–æ —Å–≤–æ–∏—Ö</div>
                    <div className="text-sm font-bold text-white">{cf.format(result.paidIn)}</div>
                </div>
                <div className="text-right">
                    <div className="text-[10px] text-indigo-200">–î–æ—Ö–æ–¥ –æ—Ç %</div>
                    <div className="text-sm font-bold text-white">{cf.format(result.income)}</div>
                </div>
            </div>
          </div>

          {/* –í–ö–õ–ê–î–ö–ò */}
          <div className="px-4 mb-6">
             <Segmented options={[{key:"calc",label:"–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"}, {key:"forecast",label:"–ü—Ä–æ–≥–Ω–æ–∑"}]} value={tab} onChange={setTab} />
          </div>

          {/* –ö–û–ù–¢–ï–ù–¢: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† */}
          {tab === "calc" && (
            <div className="px-4 space-y-4 animate-fade-in">
              
              {/* –ë–õ–û–ö 1: –ü–ê–†–ê–ú–ï–¢–†–´ */}
              <div className="bg-zinc-900/80 border border-zinc-800/50 rounded-2xl p-5 shadow-sm backdrop-blur-sm">
                <h3 className="text-sm font-bold text-white mb-6 flex items-center gap-2">
                    <span className="w-1 h-4 bg-indigo-500 rounded-full"></span>
                    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –î–≤–∏–≥–∞—Ç–µ–ª—è
                </h3>
                
                <SliderRow label="–ú–æ—è –¶–µ–ª—å" value={target} setValue={setTarget} min={100000} max={50000000} step={100000} formatFn={cf.format} />
                <SliderRow label="–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª" value={principal} setValue={setPrincipal} min={0} max={10000000} step={50000} formatFn={cf.format} />
                <SliderRow label="–°—Ä–æ–∫ (–ª–µ—Ç)" value={years} setValue={setYears} min={1} max={40} step={1} formatFn={n=>n} suffix="–ª–µ—Ç" />
                <SliderRow label="–ï–∂–µ–º–µ—Å—è—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" value={contrib} setValue={setContrib} min={0} max={500000} step={1000} formatFn={cf.format} />
                
                <div className="mt-2 pt-4 border-t border-zinc-800">
                   <Toggle checked={reinvest} onChange={setReinvest} label="–†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ö–æ–¥ (–°–ª–æ–∂–Ω—ã–π %)" />
                </div>
              </div>

              {/* –ë–õ–û–ö 2: –ê–õ–õ–û–ö–ê–¶–ò–Ø */}
              <div className="bg-zinc-900/80 border border-zinc-800/50 rounded-2xl p-5 shadow-sm backdrop-blur-sm">
                <h3 className="text-sm font-bold text-white mb-1 flex items-center gap-2">
                    <span className="w-1 h-4 bg-indigo-500 rounded-full"></span>
                    –ê–ª–ª–æ–∫–∞—Ü–∏—è –ê–∫—Ç–∏–≤–æ–≤
                </h3>
                <div className="text-[10px] text-zinc-500 mb-6 ml-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∏—Å–∫–∞ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏</div>
                
                <div className="mb-4">
                    <div className="flex justify-between text-xs mb-2 font-medium">
                        <span className="text-zinc-400">–î–æ–ª—è –û–±–ª–∏–≥–∞—Ü–∏–π (–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å)</span>
                        <span className="text-white">{(bondShare * 100).toFixed(0)}%</span>
                    </div>
                    <input type="range" min="0" max="100" step="5" value={bondShare*100} onChange={(e)=>setBondShare(e.target.value/100)} className="w-full h-2 bg-zinc-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
                </div>
                <div className="flex justify-between text-[10px] text-zinc-500 mb-6 px-1">
                   <span>–ê–∫—Ü–∏–∏: {(100 - bondShare*100).toFixed(0)}%</span>
                   <span>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—è: <span className="text-indigo-400 font-bold">{pf.format(portRet)}</span></span>
                </div>

                <EditableTable title="–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫ (–û–±–ª–∏–≥–∞—Ü–∏–∏)" rows={bonds} setRows={setBonds} colorClass="text-blue-400" />
                <EditableTable title="–ë–ª–æ–∫ —Ä–æ—Å—Ç–∞ (–ê–∫—Ü–∏–∏)" rows={stocks} setRows={setStocks} colorClass="text-purple-400" />
              </div>
            </div>
          )}

          {/* –ö–û–ù–¢–ï–ù–¢: –ü–†–û–ì–ù–û–ó */}
          {tab === "forecast" && (
            <div className="px-4 animate-fade-in">
               <div className="bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden shadow-sm">
                  <table className="w-full text-xs text-left">
                    <thead className="bg-zinc-950 text-zinc-500 uppercase font-medium tracking-wider">
                      <tr>
                        <th className="px-4 py-3">–ì–æ–¥</th>
                        <th className="px-4 py-3">–ö–∞–ø–∏—Ç–∞–ª</th>
                        <th className="px-4 py-3 text-right">–î–æ—Ö–æ–¥</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-zinc-800/50">
                      {forecast.map((r) => (
                        <tr key={r.year} className="text-zinc-300 hover:bg-zinc-800/30 transition">
                          <td className="px-4 py-3 font-mono text-zinc-500">{r.year}</td>
                          <td className="px-4 py-3 font-medium text-white">{cf.format(r.fv)}</td>
                          <td className="px-4 py-3 text-right text-green-400 font-mono">+{cf.format(r.income)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
               </div>
               <div className="text-center mt-8">
                  <button onClick={() => setTab("calc")} className="px-6 py-2 bg-zinc-800 text-zinc-300 rounded-full text-xs hover:bg-zinc-700 transition">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º</button>
               </div>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
